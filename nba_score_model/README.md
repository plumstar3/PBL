# NBAプレー価値分析モデル (Fixed Momentum Score Model)

## 1. プロジェクト概要

このプロジェクトは、バスケットボールの試合における各プレー（3Pシュート、リバウンド、ターンオーバー等）が、**試合の勝敗にどれだけの影響を与えるか**を客観的な数値（モメンタムスコア）として算出する分析モデルです。

試合状況によって変動する「動的な勝率」ではなく、「このプレーは、いつ起きても概ねこれくらいの価値がある」という**固定的で解釈しやすいスコア**を定義することに焦点を当てています。

最終的な成果として、各プレータイプごとの「モメンタムスコア」を算出し、それを用いて試合の流れを分析・可視化するためのデータを出力します。

---

## 2. 分析アプローチ：最適化問題としてのモデル化

各プレーの最適なスコアを見つけ出すために、この問題を「最適化問題」として捉え、機械学習の手法である**ロジスティック回帰**を利用しました。

#### 変数の定義
モデルで使用する主な変数は以下の通りです。

$
\begin{aligned}
g & : \text{試合のインデックス} \\
i & : \text{プレーの種類（2P成功、リバウンドなど）} \\
x_{g, \text{home}, i} & : \text{ホームチームのプレー}i\text{の回数} \\
x_{g, \text{away}, i} & : \text{アウェイチームのプレー}i\text{の回数} \\
Y_g & : \text{試合の実際の結果（1: ホーム勝利, 0: 敗北）} \\
w_{\text{home}, i} & : \text{ホームのプレー}i\text{のスコア（求めたい変数）} \\
w_{\text{away}, i} & : \text{アウェイのプレー}i\text{のスコア（求めたい変数）} \\
b & : \text{バイアス項（基本の有利不利度）}
\end{aligned}
$

#### モデルの式
ある1試合の最終的な「勢いの総量」($S_g$)を、各プレーの発生回数とスコアの合計値として計算します。

$$S_g = b + \sum_{i} \left( w_{\text{home}, i} \cdot x_{g, \text{home}, i} + w_{\text{away}, i} \cdot x_{g, \text{away}, i} \right)$$

このスコアをシグモイド関数を用いて勝利確率($P_g$)に変換し、実際の勝敗データ($Y_g$)との誤差（対数損失関数 $L(w,b)$）が最小になるように、最適なスコア（係数 $w,b$）を求めます。

$$P_g = \frac{1}{1 + e^{-S_g}}$$

$$\underset{w,b}{\arg \min} \, L(w,b)$$

---

## 3. プロジェクトのファイル構成

このプロジェクトは、以下のファイルで構成されています。

```
nba_score_model/
├── main.py                 # 全体の処理を呼び出すメインスクリプト
├── config.py               # データベースのパスや分析対象イベントなどの設定ファイル
├── data_processor.py       # データの読み込みと、試合ごとの特徴量への変換処理
├── model.py                # ロジスティック回帰モデルの訓練とスコア算出
├── game_analyzer.py        # 試合ごとの詳細な分析と結果の出力
└── utils.py                # 時間計算など、補助的な関数群
```

---

## 4. セットアップと実行方法

#### 4.1. 環境設定
このプロジェクトは `conda` 環境での実行を推奨します。必要なライブラリは以下の通りです。

- pandas
- scikit-learn
- openpyxl （Excel出力用）

ターミナルで以下のコマンドを実行してインストールしてください。
```bash
conda install pandas scikit-learn openpyxl
```

#### 4.2. データの準備
プロジェクトフォルダの一つ上の階層に、分析対象のデータベースファイル `nba.sqlite` を配置してください。

#### 4.3. 実行
すべての準備が整ったら、ターミナルで以下のコマンドを実行します。
```bash
python main.py
```

---

## 5. 分析結果と解釈

実行が完了すると、コンソールに以下の2つの主要な分析結果が出力されます。

#### 5.1. モメンタムスコア
データに基づいて算出された、各プレーの価値一覧です。全てのスコアは「ホームチームの勝率」への貢献度を示します。

（実行結果の例）
```
--- 算出されたモメンタムスコア (ホーム/アウェイ別) ---
         Event Type  Home Score  Away Score
              steal    0.850274   -0.900449
        rebound_off    0.453182   -0.463659
              block    0.411313   -0.283661
        rebound_def    0.300605   -0.176173
               foul   -0.200831    0.131718
            ft_miss   -0.278803    0.311875
shot_miss_unblocked   -0.455516    0.414886
  unforced_turnover   -0.866042    0.702205
```
この結果から、オフェンスリバウンドやブロックがいかに価値の高いプレーか、また、ホームでのターンオーバーがいかにダメージが大きいか、といった洞察が得られます。

#### 5.2. クォーターごとの逆転可能性分析
スコア上では負けているが、モメンタムスコアの累積では上回っている「逆転の兆し」がある試合を抽出し、その後の実際の勝率を計算します。

（実行結果の例）
```
--- ★注目ケース：スコアはビハインドだが、モメンタムはプラスの状況 ---
        game_id  quarter  score_diff  cumulative_momentum  final_home_win
50   0029600130        1          -4             0.027063               1
...

上記ケースのうち、最終的に勝利した試合の割合: 68.75% (11 / 16)
```
この結果は、私たちが算出したモメンタムスコアが、**目先の点差だけでは測れない試合の「本当の流れ」を捉えている**可能性を示唆しています。